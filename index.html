<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Procesando...</title>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://otvcwvnlndxtzzmeqtcw.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90dmN3dm5sbmR4dHp6bWVxdGN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3NTg0OTQsImV4cCI6MjA2MzMzNDQ5NH0.psGUAZjKc_Ic9CFeumOIwS5DNWkgtABNZlcN0iig0cE"
    );

    window.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const id_param = params.get("id");
      const id_int = parseInt(id_param, 10);

      // 1. Consultar si ya está en true
      const { data, error } = await supabase
        .from("Sugerencias")
        .select("Estado")
        .eq("id", id_int)
        .single(); // porque esperas solo un registro

      if (error) {
        console.error("❌ Error al consultar:", error);
        document.querySelector(".message").innerHTML = `
          ❌ Hubo un error al verificar el registro.<br>
          Puede cerrar esta pestaña manualmente.
        `;
        return;
      }

      if (data.Estado === true) {
        console.log("⚡ Ya estaba en true, cerrando...");
        window.close();
        document.querySelector(".message").innerHTML = `
          ⚡ Este registro ya había sido procesado.<br>
          Puede cerrar esta pestaña manualmente.
        `;
        return;
      }

      // 2. Si no estaba en true → actualizar
      const { error: updateError } = await supabase
        .from("Sugerencias")
        .update({ Estado: true })
        .eq("id", id_int);

      if (updateError) {
        console.error("❌ Error al actualizar:", updateError);
        document.querySelector(".message").innerHTML = `
          ❌ Hubo un error al procesar el registro.<br>
          Puede cerrar esta pestaña manualmente.
        `;
      } else {
        console.log("✅ Registro actualizado...");
        setTimeout(() => {
          window.close();
          document.querySelector(".message").innerHTML = `
            ✅ Registro procesado.<br>
            Puede cerrar esta pestaña manualmente.
          `;
          document.querySelector(".loader").style.display = "none";
        }, 2000);
      }
    });
  </script>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #007BFF; /* Azul */
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      flex-direction: column;
    }
    .loader {
      border: 6px solid rgba(255, 255, 255, 0.3);
      border-top: 6px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .message {
      font-size: 18px;
      max-width: 80%;
    }
  </style>
</head>
<body>
  <div class="loader"></div>
  <p class="message">Procesando... Esta página se cerrará cuando el proceso termine.</p>
</body>
</html>


